<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="product">

	<resultMap id="productAdminResult" type="productvo">
		<result property="no" column="NO"/>
	    <result property="name" column="NAME"/>
	    <result property="price" column="PRICE"/>
	    <result property="is_show" column="IS_SHOW"/>
	    <result property="category_no" column="CATEGORY_NO"/>
	    <collection property="pro_Image" column="NO" javaType="java.util.ArrayList" ofType="imagevo" select="getImageByNo"/>
	</resultMap>

	<resultMap id="productDetailAdminResult" type="productvo">
		<result property="no" column="NO"/>
	    <result property="name" column="NAME"/>
	    <result property="summary" column="SUMMARY"/>
	    <result property="detail" column="DETAIL"/>
	    <result property="is_show" column="IS_SHOW"/>
	    <result property="tot_stock" column="TOT_STOCK"/>
	    <result property="category_no" column="CATEGORY_NO"/>
	    <collection property="pro_Image" column="NO" javaType="java.util.ArrayList" ofType="imagevo" select="getImageByNo"/>
	    <collection property="option" column="NO" javaType="java.util.ArrayList" ofType="optionvo" select="getOptionByNo"/>
	</resultMap>
	
	<resultMap id="productOptionAdminResult" type="optionvo">
		<result property="no" column="NO"/>
	    <result property="name" column="NAME"/>
	    <result property="product_no" column="PRODUCT_NO"/>
	    <collection property="option_ma" column="NO" javaType="java.util.ArrayList" ofType="optionmavo" select="getOptionMasterByNo"/>
	</resultMap>
	
	<select id="getListforAdmin" resultMap="productAdminResult"> 
		select no,name, price, is_show, category_no from product
	</select>
	
	<select id="getImageByNo" resultType="imagevo">
		<![CDATA[
			select url,is_main from image where product_no = #{no} and is_main = 1
		]]>
	</select>

	<select id="getByNo" resultMap="productDetailAdminResult" parameterType="Long">
		<![CDATA[
			select no,name,summary,price,detail,is_show,tot_stock,category_no from product where no = #{value}
		]]>
	</select>
	
	<select id="getOptionByNo" resultMap="productOptionAdminResult" parameterType="Long">
		<![CDATA[
			select no,name,product_no from option where product_no = #{no}
		]]>
	</select>

	<select id="getOptionMasterByNo" resultType="optionmavo" parameterType="Long">
		<![CDATA[
			select no,value,option_no from option_master where option_no = #{value}
		]]>
	</select>
	
	<select id="getListforUser" resultType="productvo"> 
		<choose>
			<when test="category_no == null">
				<![CDATA[
					select p.no,name,summary,price,url from product p, image i 
						where p.no = i.product_no and is_show = 1 and is_main=1 order by no
				]]>
			</when>
			<otherwise>
				<![CDATA[	
					select p.no,name,summary,price,url from product p, image i 
						where p.no = i.product_no and is_show = 1 and is_main=1
							 and category_no = #{category_no} order by no
				]]>
			</otherwise>
		</choose>
	</select>
	
	<insert id="insert" parameterType="productvo">
		<![CDATA[
			insert into product(no,name,summary,price,is_show,detail,tot_stock,reg_date,category_no) 
				values(null,#{name},#{summary},#{price},#{is_show},#{detail},#{tot_stock},now(),#{category_no})
		]]>
		<selectKey keyProperty="no" resultType="long" order="AFTER">
			select
			last_insert_id()
		</selectKey>
	</insert>

	<insert id="insert_image" parameterType="imagevo">
		<![CDATA[
			insert into image(no,url,is_main,product_no) 
				values(null,#{url},#{is_main},#{product_no})
		]]>
	</insert>

	<insert id="insert_option" parameterType="optionvo">
		<![CDATA[
			insert into option(no,name,product_no) 
				values(null,#{name},#{product_no})
		]]>
		<selectKey keyProperty="no" resultType="long" order="AFTER">
			select
			last_insert_id()
		</selectKey>
	</insert>

	<insert id="insert_option_ma" parameterType="optionmavo">
		<![CDATA[
			insert into option_master(no,value,option_no) 
				values(null,#{value},#{option_no})
		]]>
	</insert>

	<insert id="insert_pro_option" parameterType="productoptionvo">
		<![CDATA[
			insert into pro_option(no,name,stock,use_stock,plus,product_no) 
				values(null,#{name},#{stock},#{use_stock},#{plus},#{product_no})
		]]>
	</insert>

	<delete id="delete_product" parameterType="Long">
		<![CDATA[
			DELETE FROM product
				WHERE no = #{value}
		]]>	
	</delete>

</mapper>
